"use strict";let serialize={isEmptyObject:t=>Reflect.ownKeys(t).length>0,getURLInfo:function(t){let e=t.indexOf("?"),n=t.indexOf("#"),i="",s="",l=null,r=null,h=t,_=null,a=null;-1!==e&&-1!==n?(h=t.substring(0,e),e>n?(s=t.substring(n+1,e),i=t.substring(e+1)):(i=t.substring(e+1,n),s=t.substring(n+1))):-1!==e?(i=t.substring(e+1),h=t.substring(0,e)):-1!==n&&(s=t.substring(n+1),h=t.substring(0,n));let o=t.match(/:[0-9]+/g),u=t.match(/[a-z]+:\/\//);_=o?o[o.length-1].substring(1):null,(a=u?u[0].substring(0,u[0].length-3):null)&&(h=h.substring(a.length+3)),_&&(h=h.substring(0,h.length-_.length-1));let c=h.substring(0,h.indexOf("/"));if(h=""===c?h:c,""!==i){l={};let t=i.split("&");for(let e=0;e<t.length;e++){let n=t[e].split("=");l[n[0]]=n[1]}}if(""!==s){r={};let t=s.split("&");for(let e=0,n=t.length;e<n;e++){let n=t[e].split("=");r[n[0]]=n[1]}}return{query:l,hash:r,host:h,port:_,protocol:a}},queryObject:function(t){return serialize.getURLInfo(t).query},hashObject:function(t){return serialize.getURLInfo(t).hash}};class Agent{constructor(t){this._context=t}add(t,e,n){return this._context.window.history.pushState(t,e,n),this}replace(t,e,n){return this._context.window.history.replaceState(t,e,n),this}onChange(t){this._context.window.onpopstate=function(e){t&&t(e)}}}class Router{constructor(t){this._context=t,this.map=[],this.list=[],this.hasDot=/\{\w*\}/g,this.url=this._context.window.location.href}add(t,e){"/"!==t[t.length-1]&&(t+="/");let n=!1,i=0,s=0,l=[],r=t.replace(this.hasDot,function(t,e){return n=!0,0===i&&(s=e),l.push(t.substring(1,t.length-1)),i++,"((?!/).)*"});if(n){let n={};n.originalpath=t,n.pattern=new RegExp("^"+r+"$"),n.count=i,n.patternString="^"+r+"/$",n.firstposition=s,n.keys=l,n.callback=e;let h=t.split("\\.");h.length>1&&(n.suffix=h[1]),this.list.push(n)}else this.map[t]=e}check(t){let e={found:!1,hasParas:!1,path:t,matchpath:"",map:{},query:serialize.queryObject(t),hash:serialize.hashObject(t),callback:null},n=t.split("?");n.length>1&&(t=n[0]);let i="",s=t.split("\\.");if(s.length>1?(i=s[1],t+="/"):"/"!==s[0][s[0]-1]&&(t=s[0]+"/"),this.map[t])return e.path=t,e.matchpath=t,e.callback=this.map[t],e.found=!0,e;{let n=null;for(let e in this.list){let s=this.list[e];s.pattern.test(t)&&(null===n?n=s:s.suffix===i&&s.count<=n.count&&s.firstposition>n.firstposition&&(n=s))}if(null!==n){let i=t.split("/"),s=n.originalpath.split("/"),l=0;for(let t=0;t<s.length;t++)"{"===s[t][0]&&(e.map[n.keys[l]]=i[t],l++);e.hasParas=!0,e.path=n.originalpath,e.matchpath=t,e.callback=info.callback,e.found=!0}return e}}}class History{constructor(t){this._context=t,this.url=this._context.window.location.origin,this._stack=[1],this._currentIndex=0,this._handler={},this.router=new Router(t),this.agent=new Agent(t),this.agent.onChange(t=>{History._run.call(this,t.state,t)})}static _run(t,e){try{t&&!serialize.isEmptyObject(t)||(t={__page__:this._context.window.location.href.split("#")[0].substring(this.url.length),__index__:0}),t.__page__=t.__page__.split("?")[0],""===t.__page__?t.__page__="/":"/"===t.__page__[t.__page__.length-1]&&(t.__page__=t.__page__.substring(t.__page__.length-1)),"/"===t.__page__&&(t.__page__="");let n=this.router.check(t.__page__),i=!1,s=!1,l={};e&&Object.assign(t,e.state),void 0!==t.__index__&&null!==t.__index__&&(t.__index__<this._currentIndex&&(i=!0),t.__index__>this._currentIndex&&(s=!0),this._currentIndex=t.__index__);for(let e in t)"__page__"!==e&&"__title__"!==e&&"__index__"!==e&&(l[e]=t[e]);let r={founded:n.found,action:n.path,path:n.path,back:i,forward:s,keys:n.hasParas?n.map:null,query:n.query,hash:n.hash,info:l,e:void 0===e?null:e,baseInfo:n},h=!0;if(this._handler.beforeopen){!1===this._handler.beforeopen.call(this,r)&&(h=!1)}n.found?(h&&n.callback&&n.callback.call(this,r),this._handler.endopen&&this._handler.endopen.call(this,r)):this._handler.nofound&&this._handler.nofound.call(this,r)}catch(e){console.log(e)}}run(){let t=this._context.window.location.href.substring(this.url.length);return History._run.call(this,{__page__:t}),this}open(t,e,n){return e||(e={}),e.__page__=t,e.__title__=n,e.__index__=this._stack.length,this.agent.add(e,n,this.url+t),this._stack.push(1),this._currentIndex=e.__index__,History._run.call(this,e),this}edit(t,e,n){return e||(e={}),e.__page__=t,this.agent.replace(e,n,this.url+t),History._run.call(this,e),this}bind(t,e){if(1===arguments.length)for(let e in t)this.router.add(e,t[e]);else 2===arguments.length&&this.router.add(t,e);return this}watch(t,e){return this._handler[t]=e,this}}module.exports=History;